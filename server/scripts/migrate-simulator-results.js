#!/usr/bin/env node

/**
 * üîÑ MIGRATION DES R√âSULTATS DU SIMULATEUR VERS CLIENTPRODUITELIGIBLE
 * Migrer les r√©sultats TemporaryEligibility vers ClientProduitEligible avec les bons montants
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// Calculateur avanc√© (copie de celui du simulateur)
class AdvancedEligibilityCalculator {
  constructor() {
    // Taux TICPE 2024 (‚Ç¨/1000L)
    this.tauxCarburant = {
      'Gazole professionnel': 61.07,
      'Gazole Non Routier (GNR)': 61.07,
      'Essence': 68.29,
      'GPL': 15.42,
      '√âlectricit√©': 0
    };

    // Coefficients par type de v√©hicule
    this.coefficientsVehicules = {
      'Camions de plus de 7,5 tonnes': 1.0,
      'Camions de 3,5 √† 7,5 tonnes': 0.8,
      'V√©hicules utilitaires l√©gers': 0.6,
      'Engins de chantier': 1.2,
      'V√©hicules de service': 0.7,
      'V√©hicules de fonction': 0.5,
      'Tracteurs agricoles': 0.9
    };

    // Estimations de consommation annuelle par v√©hicule (litres)
    this.estimationsConsommation = {
      'Moins de 5 000 litres': 3000,
      '5 000 √† 15 000 litres': 10000,
      '15 000 √† 50 000 litres': 32500,
      'Plus de 50 000 litres': 75000
    };
  }

  extractClientProfile(responses) {
    const profile = {};

    responses.forEach((response, index) => {
      // Extraire la valeur de la r√©ponse
      let value = '';
      if (Array.isArray(response.response_value)) {
        value = response.response_value;
      } else if (typeof response.response_value === 'string') {
        value = response.response_value;
      } else if (typeof response.response_value === 'object' && response.response_value !== null) {
        value = Object.values(response.response_value).join(', ');
      }

      const valueStr = Array.isArray(value) ? value.join(', ') : value;
      
      // Mapping des r√©ponses
      if (valueStr?.includes('Transport') || valueStr?.includes('Logistique')) {
        if (valueStr?.includes('marchandises') || valueStr?.includes('Logistique')) {
          profile.secteur = 'Transport routier de marchandises';
        } else if (valueStr?.includes('voyageurs')) {
          profile.secteur = 'Transport routier de voyageurs';
        } else {
          profile.secteur = 'Transport routier de marchandises';
        }
      } else if (valueStr?.includes('BTP') || valueStr?.includes('Travaux')) {
        profile.secteur = 'BTP / Travaux publics';
      } else if (valueStr?.includes('Taxi') || valueStr?.includes('VTC')) {
        profile.secteur = 'Taxi / VTC';
      } else if (valueStr?.includes('Agricole')) {
        profile.secteur = 'Secteur Agricole';
      }

      if (valueStr?.includes('Oui') && (valueStr?.includes('v√©hicule') || valueStr?.includes('professionnel'))) {
        profile.vehiculesProfessionnels = 'Oui';
      }

      if (valueStr?.includes('1 √† 3')) profile.nombreVehicules = '1 √† 3 v√©hicules';
      else if (valueStr?.includes('4 √† 10')) profile.nombreVehicules = '4 √† 10 v√©hicules';
      else if (valueStr?.includes('11 √† 25')) profile.nombreVehicules = '11 √† 25 v√©hicules';
      else if (valueStr?.includes('Plus de 25')) profile.nombreVehicules = 'Plus de 25 v√©hicules';

      if (valueStr?.includes('Camion') && valueStr?.includes('7,5 tonnes')) {
        if (!profile.typesVehicules) profile.typesVehicules = [];
        profile.typesVehicules.push('Camions de plus de 7,5 tonnes');
      }
      if (valueStr?.includes('Camion') && valueStr?.includes('3,5 √† 7,5')) {
        if (!profile.typesVehicules) profile.typesVehicules = [];
        profile.typesVehicules.push('Camions de 3,5 √† 7,5 tonnes');
      }
      if (valueStr?.includes('utilitaire') || valueStr?.includes('Utilitaire')) {
        if (!profile.typesVehicules) profile.typesVehicules = [];
        profile.typesVehicules.push('V√©hicules utilitaires l√©gers');
      }
      if (valueStr?.includes('engin') || valueStr?.includes('Engin')) {
        if (!profile.typesVehicules) profile.typesVehicules = [];
        profile.typesVehicules.push('Engins de chantier');
      }
      if (valueStr?.includes('Tracteur') || valueStr?.includes('tracteur')) {
        if (!profile.typesVehicules) profile.typesVehicules = [];
        profile.typesVehicules.push('Tracteurs agricoles');
      }

      if (valueStr?.includes('Plus de 50 000')) {
        profile.consommationCarburant = 'Plus de 50 000 litres';
      } else if (valueStr?.includes('15 000 √† 50 000')) {
        profile.consommationCarburant = '15 000 √† 50 000 litres';
      } else if (valueStr?.includes('5 000 √† 15 000')) {
        profile.consommationCarburant = '5 000 √† 15 000 litres';
      } else if (valueStr?.includes('Moins de 5 000')) {
        profile.consommationCarburant = 'Moins de 5 000 litres';
      }

      if (valueStr?.includes('Gazole') && !valueStr?.includes('Non Routier') && !valueStr?.includes('GNR')) {
        if (!profile.typesCarburant) profile.typesCarburant = [];
        profile.typesCarburant.push('Gazole professionnel');
      }
      if (valueStr?.includes('GNR') || valueStr?.includes('Non Routier')) {
        if (!profile.typesCarburant) profile.typesCarburant = [];
        profile.typesCarburant.push('Gazole Non Routier (GNR)');
      }
      if (valueStr?.includes('Essence')) {
        if (!profile.typesCarburant) profile.typesCarburant = [];
        profile.typesCarburant.push('Essence');
      }

      if (valueStr?.includes('3 derni√®res ann√©es compl√®tes')) {
        profile.facturesCarburant = 'Oui, 3 derni√®res ann√©es compl√®tes';
      } else if (valueStr?.includes('2 derni√®res ann√©es')) {
        profile.facturesCarburant = 'Oui, 2 derni√®res ann√©es';
      } else if (valueStr?.includes('1 derni√®re ann√©e')) {
        profile.facturesCarburant = 'Oui, 1 derni√®re ann√©e';
      } else if (valueStr?.includes('Partiellement')) {
        profile.facturesCarburant = 'Partiellement';
      }

      if (valueStr?.includes('100% professionnel')) {
        profile.usageProfessionnel = '100% professionnel';
      } else if (valueStr?.includes('80-99%')) {
        profile.usageProfessionnel = '80-99% professionnel';
      } else if (valueStr?.includes('60-79%')) {
        profile.usageProfessionnel = '60-79% professionnel';
      }

      if (valueStr?.includes('toutes les stations')) {
        profile.cartesCarburant = 'Oui, toutes les stations';
      } else if (valueStr?.includes('partiellement')) {
        profile.cartesCarburant = 'Oui, partiellement';
      } else if (valueStr?.includes('Non')) {
        profile.cartesCarburant = 'Non';
      }

      if (valueStr?.includes('syst√©matiquement')) {
        profile.facturesNominatives = 'Oui, syst√©matiquement';
      } else if (valueStr?.includes('partiellement')) {
        profile.facturesNominatives = 'Oui, partiellement';
      }

      if (valueStr?.includes('100%')) {
        profile.immatriculationSociete = 'Oui, 100%';
      } else if (valueStr?.includes('majoritairement')) {
        profile.immatriculationSociete = 'Oui, majoritairement';
      }

      if (valueStr?.includes('r√©guli√®rement')) {
        profile.declarationsTicpe = 'Oui, r√©guli√®rement';
      } else if (valueStr?.includes('occasionnellement')) {
        profile.declarationsTicpe = 'Oui, occasionnellement';
      }

      if (valueStr?.includes('Plus de 5 000 000‚Ç¨')) {
        profile.chiffreAffaires = 'Plus de 5 000 000‚Ç¨';
      } else if (valueStr?.includes('1 000 000‚Ç¨ - 5 000 000‚Ç¨')) {
        profile.chiffreAffaires = '1 000 000‚Ç¨ - 5 000 000‚Ç¨';
      } else if (valueStr?.includes('500 000‚Ç¨ - 1 000 000‚Ç¨')) {
        profile.chiffreAffaires = '500 000‚Ç¨ - 1 000 000‚Ç¨';
      } else if (valueStr?.includes('100 000‚Ç¨ - 500 000‚Ç¨')) {
        profile.chiffreAffaires = '100 000‚Ç¨ - 500 000‚Ç¨';
      } else if (valueStr?.includes('Moins de 100 000‚Ç¨')) {
        profile.chiffreAffaires = 'Moins de 100 000‚Ç¨';
      }
    });

    // M√âTHODE OPTIMALE : D√©duire la pr√©sence de v√©hicules professionnels
    if (!profile.vehiculesProfessionnels || profile.vehiculesProfessionnels !== 'Oui') {
      if (
        (profile.nombreVehicules && typeof profile.nombreVehicules === 'string' && !profile.nombreVehicules.includes('0')) ||
        (profile.typesVehicules && Array.isArray(profile.typesVehicules) && profile.typesVehicules.length > 0)
      ) {
        profile.vehiculesProfessionnels = 'Oui';
      }
    }

    return profile;
  }

  calculateTICPESavings(responses) {
    const profile = this.extractClientProfile(responses);
    
    if (!profile.vehiculesProfessionnels || profile.vehiculesProfessionnels !== 'Oui') {
      return { savings: 0, score: 0, confidence: 'faible' };
    }

    if (!profile.typesCarburant || profile.typesCarburant.length === 0) {
      return { savings: 0, score: 0, confidence: 'faible' };
    }

    if (!profile.consommationCarburant) {
      return { savings: 0, score: 0, confidence: 'faible' };
    }

    const consommationAnnuelle = this.estimationsConsommation[profile.consommationCarburant] || 0;
    const tauxCarburant = this.getFuelRate(profile.typesCarburant, profile.secteur);
    const coefficientVehicule = this.getVehicleCoefficient(profile.typesVehicules || []);
    
    let economieBase = (consommationAnnuelle / 1000) * tauxCarburant * coefficientVehicule;
    let coefficientProfil = 1.0;
    
    if (profile.facturesCarburant === 'Oui, 3 derni√®res ann√©es compl√®tes') {
      coefficientProfil *= 1.2;
    } else if (profile.facturesCarburant === 'Oui, 2 derni√®res ann√©es') {
      coefficientProfil *= 1.1;
    } else if (profile.facturesCarburant === 'Partiellement') {
      coefficientProfil *= 0.8;
    }

    if (profile.usageProfessionnel === '100% professionnel') {
      coefficientProfil *= 1.0;
    } else if (profile.usageProfessionnel === '80-99% professionnel') {
      coefficientProfil *= 0.9;
    } else if (profile.usageProfessionnel === '60-79% professionnel') {
      coefficientProfil *= 0.7;
    }

    if (profile.cartesCarburant === 'Oui, toutes les stations') {
      coefficientProfil *= 1.1;
    } else if (profile.cartesCarburant === 'Non') {
      coefficientProfil *= 0.9;
    }

    if (profile.facturesNominatives === 'Oui, syst√©matiquement') {
      coefficientProfil *= 1.1;
    } else if (profile.facturesNominatives === 'Non') {
      coefficientProfil *= 0.8;
    }

    if (profile.immatriculationSociete === 'Oui, 100%') {
      coefficientProfil *= 1.0;
    } else if (profile.immatriculationSociete === 'Non') {
      coefficientProfil *= 0.7;
    }

    if (profile.declarationsTicpe === 'Oui, r√©guli√®rement') {
      coefficientProfil *= 0.9;
    } else if (profile.declarationsTicpe === 'Non') {
      coefficientProfil *= 1.2;
    }

    const economieFinale = economieBase * coefficientProfil;
    
    let score = 0;
    if (economieFinale > 0) score += 20;
    if (profile.facturesCarburant?.includes('3 derni√®res ann√©es')) score += 20;
    if (profile.usageProfessionnel === '100% professionnel') score += 15;
    if (profile.cartesCarburant === 'Oui, toutes les stations') score += 10;
    if (profile.facturesNominatives === 'Oui, syst√©matiquement') score += 10;
    if (profile.immatriculationSociete === 'Oui, 100%') score += 10;
    if (profile.declarationsTicpe === 'Non') score += 15;

    let confidence = 'faible';
    if (score >= 80) confidence = '√©lev√©';
    else if (score >= 60) confidence = 'moyen';
    else if (score >= 40) confidence = 'mod√©r√©';

    return {
      savings: Math.round(economieFinale),
      score: Math.min(score, 100),
      confidence
    };
  }

  getFuelRate(typesCarburant, secteur) {
    let tauxTotal = 0;
    let poidsTotal = 0;

    typesCarburant.forEach(type => {
      const taux = this.tauxCarburant[type] || 0;
      const poids = type.includes('Gazole') ? 0.7 : 0.3;
      tauxTotal += taux * poids;
      poidsTotal += poids;
    });

    return poidsTotal > 0 ? tauxTotal / poidsTotal : 61.07;
  }

  getVehicleCoefficient(typesVehicules) {
    if (typesVehicules.length === 0) return 0.8;

    let coefficientTotal = 0;
    typesVehicules.forEach(type => {
      coefficientTotal += this.coefficientsVehicules[type] || 0.8;
    });

    return coefficientTotal / typesVehicules.length;
  }
}

async function migrateSimulatorResults() {
  console.log('üîÑ MIGRATION DES R√âSULTATS DU SIMULATEUR');
  console.log('=' .repeat(60));

  try {
    // R√©cup√©rer toutes les sessions compl√©t√©es avec des r√©sultats
    const { data: sessions, error: sessionsError } = await supabase
      .from('TemporarySession')
      .select(`
        *,
        TemporaryEligibility (
          produit_id,
          eligibility_score,
          estimated_savings,
          confidence_level,
          recommendations
        )
      `)
      .eq('completed', true)
      .order('created_at', { ascending: false });

    if (sessionsError) {
      console.error('‚ùå Erreur r√©cup√©ration sessions:', sessionsError);
      return;
    }

    console.log(`‚úÖ ${sessions.length} sessions compl√©t√©es trouv√©es`);

    const calculator = new AdvancedEligibilityCalculator();
    let migratedCount = 0;
    let updatedCount = 0;

    for (const session of sessions) {
      console.log(`\nüìä Traitement session: ${session.session_token}`);

      // R√©cup√©rer les r√©ponses de cette session
      const { data: responses, error: responsesError } = await supabase
        .from('TemporaryResponse')
        .select('*')
        .eq('session_id', session.id)
        .order('created_at', { ascending: true });

      if (responsesError || !responses) {
        console.log(`‚ö†Ô∏è Pas de r√©ponses pour cette session`);
        continue;
      }

      // R√©cup√©rer ou cr√©er le client permanent directement
      let clientId = null;
      
      // Chercher d'abord un client existant avec le m√™me email (g√©n√©r√© √† partir du session_token)
      const generatedEmail = `simulateur_${session.session_token.substring(0, 8)}@example.com`;
      
      const { data: existingClient, error: existingError } = await supabase
        .from('clients')
        .select('id')
        .eq('email', generatedEmail)
        .single();

      if (existingClient) {
        clientId = existingClient.id;
        console.log(`   ‚Üí Client existant trouv√©: ${clientId}`);
      } else {
        // Cr√©er un nouveau client avec des donn√©es g√©n√©r√©es
        const { data: newClient, error: newClientError } = await supabase
          .from('clients')
          .insert({
            email: generatedEmail,
            username: `Client_${session.session_token.substring(0, 8)}`,
            company_name: `Entreprise_${session.session_token.substring(0, 8)}`,
            phone_number: '01 23 45 67 89',
            address: '123 Rue du Commerce',
            city: 'Paris',
            postal_code: '75001',
            siren: '123456789',
            statut: 'Actif',
            revenuannuel: 1000000,
            secteuractivite: 'Transport',
            nombreemployes: 25,
            ancienneteentreprise: 5
          })
          .select('id')
          .single();

        if (newClientError) {
          console.log(`‚ùå Erreur cr√©ation client: ${newClientError.message}`);
          continue;
        }

        clientId = newClient.id;
        console.log(`   ‚Üí Nouveau client cr√©√©: ${clientId}`);
      }

      // Traiter chaque produit √©ligible
      for (const eligibility of session.TemporaryEligibility || []) {
        console.log(`   üéØ Traitement produit: ${eligibility.produit_id}`);

        // Recalculer avec le calculateur avanc√©
        let recalculatedResult = null;
        
        if (eligibility.produit_id === 'TICPE') {
          recalculatedResult = calculator.calculateTICPESavings(responses);
        } else {
          // Pour les autres produits, utiliser les valeurs existantes
          recalculatedResult = {
            savings: eligibility.estimated_savings || 0,
            score: eligibility.eligibility_score || 0,
            confidence: eligibility.confidence_level || 'faible'
          };
        }

        // V√©rifier si l'√©ligibilit√© existe d√©j√†
        const { data: existingEligibility, error: existingEligError } = await supabase
          .from('ClientProduitEligible')
          .select('id')
          .eq('clientId', clientId)
          .eq('produitId', eligibility.produit_id)
          .single();

        const eligibilityData = {
          clientId: clientId,
          produitId: eligibility.produit_id,
          statut: recalculatedResult.score >= 50 ? 'eligible' : 'non_eligible',
          tauxFinal: recalculatedResult.score / 100,
          montantFinal: recalculatedResult.savings,
          dureeFinale: 12, // 12 mois par d√©faut
          simulationId: session.id,
          metadata: {
            confidence_level: recalculatedResult.confidence,
            recommendations: eligibility.recommendations || [],
            session_token: session.session_token,
            calculated_at: new Date().toISOString()
          },
          notes: `Migration depuis simulateur - Score: ${recalculatedResult.score}%, Confiance: ${recalculatedResult.confidence}`,
          priorite: recalculatedResult.score >= 80 ? 1 : recalculatedResult.score >= 60 ? 2 : 3,
          dateEligibilite: new Date().toISOString(),
          current_step: 0,
          progress: 0
        };

        if (existingEligibility) {
          // Mettre √† jour l'√©ligibilit√© existante
          const { error: updateError } = await supabase
            .from('ClientProduitEligible')
            .update(eligibilityData)
            .eq('id', existingEligibility.id);

          if (updateError) {
            console.log(`‚ùå Erreur mise √† jour: ${updateError.message}`);
          } else {
            updatedCount++;
            console.log(`   ‚úÖ √âligibilit√© mise √† jour - Montant: ${recalculatedResult.savings}‚Ç¨`);
          }
        } else {
          // Cr√©er une nouvelle √©ligibilit√©
          const { error: insertError } = await supabase
            .from('ClientProduitEligible')
            .insert(eligibilityData);

          if (insertError) {
            console.log(`‚ùå Erreur cr√©ation: ${insertError.message}`);
          } else {
            migratedCount++;
            console.log(`   ‚úÖ Nouvelle √©ligibilit√© cr√©√©e - Montant: ${recalculatedResult.savings}‚Ç¨`);
          }
        }
      }
    }

    console.log('\nüéØ R√âSUM√â DE LA MIGRATION:');
    console.log('‚îÄ'.repeat(40));
    console.log(`üìä Sessions trait√©es: ${sessions.length}`);
    console.log(`üÜï Nouvelles √©ligibilit√©s cr√©√©es: ${migratedCount}`);
    console.log(`üîÑ √âligibilit√©s mises √† jour: ${updatedCount}`);
    console.log(`‚úÖ Migration termin√©e avec succ√®s !`);

  } catch (error) {
    console.error('‚ùå Erreur g√©n√©rale:', error);
  }
}

// Ex√©cution
if (require.main === module) {
  migrateSimulatorResults().catch(console.error);
}

module.exports = { migrateSimulatorResults }; 