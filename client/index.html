<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profitum</title>
    <!-- Manifest sera charg√© dynamiquement par le script ci-dessous -->
    <link rel="manifest" id="pwa-manifest" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icon-96x96.png" />
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
    <meta name="theme-color" content="#2563eb" id="pwa-theme-color" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Profitum" id="pwa-apple-title" />
    
    <!-- Script pour charger le manifest dynamiquement selon le type d'utilisateur -->
    <script>
      (function() {
        // Fonction pour d√©terminer le type d'utilisateur
        function getUserType() {
          // V√©rifier localStorage (utilis√© lors de l'installation PWA)
          const pwaUserType = localStorage.getItem('pwa_user_type');
          if (pwaUserType && ['client', 'expert', 'apporteur', 'admin'].includes(pwaUserType)) {
            return pwaUserType;
          }
          
          // V√©rifier l'URL pour d√©tecter les admins
          if (window.location.pathname.includes('/connect-admin') || 
              window.location.pathname.includes('/admin')) {
            return 'admin';
          }
          
          // Par d√©faut, utiliser "client"
          return 'client';
        }
        
        // Fonction pour mettre √† jour les m√©tadonn√©es Apple
        function updateAppleMetadata(userType) {
          const appNames = {
            client: 'Profitum Client',
            expert: 'Profitum Expert',
            apporteur: 'Profitum Sales',
            admin: 'Profitum Admin'
          };
          
          const appName = appNames[userType] || 'Profitum Client';
          
          // Mettre √† jour le titre Apple
          const appleTitle = document.getElementById('pwa-apple-title');
          if (appleTitle) {
            appleTitle.setAttribute('content', appName);
          }
          
          // Mettre √† jour le titre de la page
          document.title = appName;
        }
        
        // Fonction pour charger le manifest
        function loadManifest(userType) {
          const manifestLink = document.getElementById('pwa-manifest');
          if (!manifestLink) {
            console.error('√âl√©ment manifest non trouv√©');
            return;
          }
          
          // Construire l'URL du manifest
          const manifestUrl = `/api/manifest/${userType}`;
          
          // Mettre √† jour le href du manifest
          manifestLink.setAttribute('href', manifestUrl);
          
          // Charger le manifest pour mettre √† jour les m√©tadonn√©es
          fetch(manifestUrl)
            .then(response => response.json())
            .then(manifest => {
              // Mettre √† jour le theme-color
              const themeColorMeta = document.getElementById('pwa-theme-color');
              if (themeColorMeta && manifest.theme_color) {
                themeColorMeta.setAttribute('content', manifest.theme_color);
              }
              
              // Mettre √† jour les m√©tadonn√©es Apple
              updateAppleMetadata(userType);
              
              console.log('‚úÖ Manifest charg√© pour type:', userType, 'Nom:', manifest.name);
            })
            .catch(error => {
              console.error('Erreur lors du chargement du manifest:', error);
              // En cas d'erreur, utiliser le manifest par d√©faut
              manifestLink.setAttribute('href', '/manifest.json');
            });
        }
        
        // Charger le manifest au chargement de la page
        const userType = getUserType();
        loadManifest(userType);
        
        // √âcouter les changements de localStorage pour mettre √† jour le manifest
        // (utile si l'utilisateur se connecte apr√®s le chargement de la page)
        window.addEventListener('storage', function(e) {
          if (e.key === 'pwa_user_type') {
            const newUserType = e.newValue;
            if (newUserType && ['client', 'expert', 'apporteur', 'admin'].includes(newUserType)) {
              loadManifest(newUserType);
            }
          }
        });
        
        // Exposer une fonction globale pour mettre √† jour le manifest depuis React
        window.updatePWAManifest = function(newUserType) {
          if (newUserType && ['client', 'expert', 'apporteur', 'admin'].includes(newUserType)) {
            localStorage.setItem('pwa_user_type', newUserType);
            loadManifest(newUserType);
          }
        };
      })();
    </script>
    <!-- Script de redirection PWA ADMIN - DOIT √äTRE EX√âCUT√â EN PREMIER -->
    <script>
      // Redirection IMM√âDIATE pour les admins en mode PWA
      // Ce script s'ex√©cute AVANT React pour garantir la redirection
      (function() {
        // V√©rifier si on est en mode PWA (standalone)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                             (window.navigator.standalone === true);
        
        if (isStandalone) {
          // V√©rifier le type d'utilisateur dans localStorage
          const pwaUserType = localStorage.getItem('pwa_user_type');
          
          // Si admin, rediriger IMM√âDIATEMENT vers www.profitum.app/connect-admin
          if (pwaUserType === 'admin') {
            console.log('üö® ADMIN D√âTECT√â EN PWA - Redirection IMM√âDIATE vers www.profitum.app/connect-admin');
            // Redirection compl√®te - ne pas attendre React
            window.location.href = 'https://www.profitum.app/connect-admin';
            return; // Arr√™ter l'ex√©cution
          }
          
          // V√©rifier aussi l'URL de d√©marrage
          const pwaStartUrl = localStorage.getItem('pwa_start_url');
          if (pwaStartUrl && pwaStartUrl.startsWith('https://www.profitum.app/connect-admin')) {
            console.log('üö® URL ADMIN D√âTECT√âE - Redirection IMM√âDIATE vers www.profitum.app/connect-admin');
            window.location.href = 'https://www.profitum.app/connect-admin';
            return;
          }
        }
      })();
    </script>
    
    <!-- Script pour les routes SPA -->
    <script>
      // Redirection SPA - pour √©viter les 404 en cas de rechargement direct
      (function() {
        // Obtenir le chemin actuel
        const path = window.location.pathname;
        
        // V√©rifier si c'est un UUID au format attendu
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        
        // Extraire l'ID client de l'URL si le format correspond
        if (path.startsWith('/dashboard/client/')) {
          const parts = path.split('/');
          if (parts.length >= 4) {
            const potentialUUID = parts[3];
            console.log("Potential UUID found:", potentialUUID);
            
            if (uuidRegex.test(potentialUUID)) {
              // Stocker l'UUID pour le r√©cup√©rer dans le composant Dashboard
              sessionStorage.setItem('current_client_uuid', potentialUUID);
              console.log("UUID stored in sessionStorage:", potentialUUID);
            }
          }
        }
      })();
    </script>
    
    <!-- Handler global pour les erreurs -->
    <script>
      window.addEventListener('error', function(event) {
        console.error('Erreur globale d√©tect√©e:', event.error);
        
        // Afficher un message dans la console
        console.error('Message:', event.message);
        console.error('Source:', event.filename);
        console.error('Ligne:', event.lineno);
        console.error('Colonne:', event.colno);
        
        // Emp√™cher le navigateur d'afficher son propre message d'erreur
        event.preventDefault();
        
        // Si l'√©cran est blanc, essayer de fournir un message visible
        if (document.body && !document.body.hasChildNodes()) {
          const errorDiv = document.createElement('div');
          errorDiv.style.padding = '20px';
          errorDiv.style.margin = '20px';
          errorDiv.style.color = 'red';
          errorDiv.style.border = '1px solid red';
          errorDiv.style.borderRadius = '5px';
          errorDiv.innerHTML = `<h3>Une erreur est survenue</h3>
            <p>Message: ${event.message}</p>
            <p>Source: ${event.filename}</p>
            <p>Ligne: ${event.lineno}, Colonne: ${event.colno}</p>
            <button onclick="window.location.reload()">Recharger la page</button>`;
          document.body.appendChild(errorDiv);
        }
      });
      
      // Handler pour les rejets de promesses non g√©r√©s
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Promesse rejet√©e non g√©r√©e:', event.reason);
      });
    </script>
    <script type="text/javascript">
      // Charger Clarity uniquement si l'utilisateur a consenti
      (function() {
        const consent = localStorage.getItem('cookie_consent');
        if (consent) {
          try {
            const parsed = JSON.parse(consent);
            if (parsed.analytics === true) {
              (function(c,l,a,r,i,t,y){
                c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
                t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
                y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
              })(window, document, "clarity", "script", "sif392inpt");
            }
          } catch(e) {
            // Ignorer les erreurs de parsing
          }
        }
      })();
    </script>

  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
