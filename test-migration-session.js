#!/usr/bin/env node

/**
 * Script de test du process de migration session temporaire ‚Üí compte client
 * ========================================================================
 * 
 * Ce script teste l'ensemble du processus de migration :
 * 1. Cr√©ation d'une session temporaire
 * 2. Ajout de r√©ponses au simulateur
 * 3. Calcul d'√©ligibilit√©
 * 4. Migration vers un compte client
 * 5. V√©rification des donn√©es migr√©es
 */

const fetch = require('node-fetch');
const { v4: uuidv4 } = require('uuid');

// Configuration
const API_BASE_URL = process.env.API_URL || 'http://localhost:5001';
const TEST_EMAIL = `test-migration-${Date.now()}@example.com`;
const TEST_PASSWORD = 'TestPassword123!';

// Couleurs pour les logs
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function logStep(step, description) {
  log(`\n${colors.bright}${colors.blue}=== √âTAPE ${step} ===${colors.reset}`);
  log(`${colors.cyan}${description}${colors.reset}`);
}

function logSuccess(message) {
  log(`‚úÖ ${message}`, 'green');
}

function logError(message) {
  log(`‚ùå ${message}`, 'red');
}

function logWarning(message) {
  log(`‚ö†Ô∏è ${message}`, 'yellow');
}

function logInfo(message) {
  log(`‚ÑπÔ∏è ${message}`, 'blue');
}

class MigrationTester {
  constructor() {
    this.sessionToken = null;
    this.sessionId = null;
    this.clientId = null;
    this.testResults = {
      sessionCreated: false,
      responsesAdded: false,
      eligibilityCalculated: false,
      migrationCompleted: false,
      dataVerified: false
    };
  }

  async runTests() {
    log(`${colors.bright}${colors.magenta}üöÄ D√âBUT DES TESTS DE MIGRATION SESSION ‚Üí CLIENT${colors.reset}`, 'magenta');
    log(`üìÖ ${new Date().toISOString()}`, 'cyan');
    log(`üéØ Email de test: ${TEST_EMAIL}`, 'cyan');

    try {
      // √âtape 1: Cr√©er une session temporaire
      await this.createTemporarySession();

      // √âtape 2: Ajouter des r√©ponses au simulateur
      await this.addSimulatorResponses();

      // √âtape 3: Calculer l'√©ligibilit√©
      await this.calculateEligibility();

      // √âtape 4: V√©rifier que la session peut √™tre migr√©e
      await this.checkMigrationEligibility();

      // √âtape 5: R√©cup√©rer les donn√©es de session
      await this.getSessionData();

      // √âtape 6: Effectuer la migration
      await this.performMigration();

      // √âtape 7: V√©rifier les donn√©es migr√©es
      await this.verifyMigratedData();

      // √âtape 8: Afficher le rapport final
      this.displayFinalReport();

    } catch (error) {
      logError(`Erreur lors des tests: ${error.message}`);
      console.error(error);
      process.exit(1);
    }
  }

  async createTemporarySession() {
    logStep(1, 'Cr√©ation d\'une session temporaire');

    const sessionData = {
      email: TEST_EMAIL,
      company_name: 'Entreprise Test Migration',
      secteurActivite: 'Transport',
      nombreEmployes: 15,
      revenuAnnuel: 1200000,
      ancienneteEntreprise: 8
    };

    try {
      const response = await fetch(`${API_BASE_URL}/api/simulator/session`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(sessionData)
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(`Erreur cr√©ation session: ${result.error}`);
      }

      this.sessionToken = result.data.session_token;
      this.sessionId = result.data.session_id;

      logSuccess(`Session cr√©√©e avec succ√®s`);
      logInfo(`Token: ${this.sessionToken.substring(0, 20)}...`);
      logInfo(`ID: ${this.sessionId}`);

      this.testResults.sessionCreated = true;

    } catch (error) {
      logError(`√âchec cr√©ation session: ${error.message}`);
      throw error;
    }
  }

  async addSimulatorResponses() {
    logStep(2, 'Ajout de r√©ponses au simulateur');

    // R√©cup√©rer les questions disponibles
    try {
      const questionsResponse = await fetch(`${API_BASE_URL}/api/simulator/questions`);
      const questionsResult = await questionsResponse.json();

      if (!questionsResult.success) {
        throw new Error(`Erreur r√©cup√©ration questions: ${questionsResult.error}`);
      }

      const questions = questionsResult.data;
      logInfo(`${questions.length} questions r√©cup√©r√©es`);

      // R√©ponses de test pour un transporteur
      const testResponses = [
        { question_id: 'secteur_activite', response_value: 'Transport de marchandises' },
        { question_id: 'nombre_employes', response_value: '5 √† 20 employ√©s' },
        { question_id: 'chiffre_affaires', response_value: 'Entre 500k‚Ç¨ et 2M‚Ç¨' },
        { question_id: 'vehicules_lourds', response_value: 'Oui, v√©hicules lourds' },
        { question_id: 'carburant_consommation', response_value: 'Plus de 50 000L/an' },
        { question_id: 'contrats_urssaf', response_value: 'Oui' },
        { question_id: 'exonerations_sociales', response_value: 'Oui (exon√©rations ZFU, JEI, CIR, etc.)' },
        { question_id: 'locaux_proprietaire', response_value: 'Oui' },
        { question_id: 'contrats_speciaux', response_value: 'Oui' }
      ];

      // Envoyer les r√©ponses
      for (const response of testResponses) {
        const responseData = {
          session_token: this.sessionToken,
          question_id: response.question_id,
          response_value: response.response_value
        };

        const responseResult = await fetch(`${API_BASE_URL}/api/simulator/response`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(responseData)
        });

        const result = await responseResult.json();

        if (!result.success) {
          logWarning(`R√©ponse ${response.question_id} non trait√©e: ${result.error}`);
        }
      }

      logSuccess(`${testResponses.length} r√©ponses ajout√©es`);
      this.testResults.responsesAdded = true;

    } catch (error) {
      logError(`√âchec ajout r√©ponses: ${error.message}`);
      throw error;
    }
  }

  async calculateEligibility() {
    logStep(3, 'Calcul de l\'√©ligibilit√©');

    try {
      const response = await fetch(`${API_BASE_URL}/api/simulator/calculate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          session_token: this.sessionToken
        })
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(`Erreur calcul √©ligibilit√©: ${result.error}`);
      }

      const eligibilityResults = result.data.eligibility_results;
      const totalSavings = eligibilityResults.reduce((sum, r) => sum + r.estimated_savings, 0);

      logSuccess(`√âligibilit√© calcul√©e avec succ√®s`);
      logInfo(`${eligibilityResults.length} produits analys√©s`);
      logInfo(`√âconomies totales: ${totalSavings.toLocaleString('fr-FR')}‚Ç¨`);
      
      // Afficher les r√©sultats d√©taill√©s
      eligibilityResults.forEach(result => {
        const status = result.eligibility_score >= 70 ? 'üü¢' : result.eligibility_score >= 50 ? 'üü°' : 'üî¥';
        log(`${status} ${result.produit_id}: ${result.eligibility_score}% - ${result.estimated_savings.toLocaleString('fr-FR')}‚Ç¨`);
      });

      this.testResults.eligibilityCalculated = true;

    } catch (error) {
      logError(`√âchec calcul √©ligibilit√©: ${error.message}`);
      throw error;
    }
  }

  async checkMigrationEligibility() {
    logStep(4, 'V√©rification de l\'√©ligibilit√© √† la migration');

    try {
      const response = await fetch(`${API_BASE_URL}/api/session-migration/can-migrate/${this.sessionToken}`);
      const result = await response.json();

      if (!result.success) {
        throw new Error(`Erreur v√©rification migration: ${result.error}`);
      }

      if (result.can_migrate) {
        logSuccess('Session √©ligible √† la migration');
      } else {
        throw new Error('Session non √©ligible √† la migration');
      }

    } catch (error) {
      logError(`√âchec v√©rification migration: ${error.message}`);
      throw error;
    }
  }

  async getSessionData() {
    logStep(5, 'R√©cup√©ration des donn√©es de session');

    try {
      const response = await fetch(`${API_BASE_URL}/api/session-migration/session-data/${this.sessionToken}`);
      const result = await response.json();

      if (!result.success) {
        throw new Error(`Erreur r√©cup√©ration donn√©es: ${result.error}`);
      }

      const data = result.data;
      logSuccess('Donn√©es de session r√©cup√©r√©es');
      logInfo(`R√©ponses: ${data.responses.length}`);
      logInfo(`R√©sultats √©ligibilit√©: ${data.eligibility_results.length}`);
      logInfo(`Donn√©es client extraites: ${Object.keys(data.extracted_client_data).length} champs`);

      // Afficher les donn√©es extraites
      log('üìã Donn√©es client extraites:');
      Object.entries(data.extracted_client_data).forEach(([key, value]) => {
        log(`   - ${key}: ${value}`);
      });

    } catch (error) {
      logError(`√âchec r√©cup√©ration donn√©es: ${error.message}`);
      throw error;
    }
  }

  async performMigration() {
    logStep(6, 'Migration vers compte client');

    const migrationData = {
      sessionToken: this.sessionToken,
      sessionId: this.sessionToken,
      clientData: {
        email: TEST_EMAIL,
        password: TEST_PASSWORD,
        username: 'TestMigration',
        company_name: 'Entreprise Test Migration',
        phone_number: '0123456789',
        address: '123 Rue de Test',
        city: 'Paris',
        postal_code: '75001',
        siren: '123456789'
      }
    };

    try {
      const response = await fetch(`${API_BASE_URL}/api/session-migration/migrate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(migrationData)
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(`Erreur migration: ${result.error}`);
      }

      this.clientId = result.data.client_id;
      const clientProduitEligibles = result.data.client_produit_eligibles;

      logSuccess('Migration r√©ussie');
      logInfo(`Client ID: ${this.clientId}`);
      logInfo(`Produits √©ligibles cr√©√©s: ${clientProduitEligibles?.length || 0}`);

      // Afficher les d√©tails de migration
      const details = result.data.migration_details;
      log('üìä D√©tails de migration:');
      Object.entries(details).forEach(([key, value]) => {
        const status = value ? '‚úÖ' : '‚ùå';
        log(`   ${status} ${key}: ${value}`);
      });

      this.testResults.migrationCompleted = true;

    } catch (error) {
      logError(`√âchec migration: ${error.message}`);
      throw error;
    }
  }

  async verifyMigratedData() {
    logStep(7, 'V√©rification des donn√©es migr√©es');

    try {
      // V√©rifier que le client existe
      const clientResponse = await fetch(`${API_BASE_URL}/api/clients/${this.clientId}`);
      const clientResult = await clientResponse.json();

      if (!clientResult.success) {
        throw new Error(`Client non trouv√©: ${clientResult.error}`);
      }

      const client = clientResult.data;
      logSuccess('Client v√©rifi√©');
      logInfo(`Email: ${client.email}`);
      logInfo(`Entreprise: ${client.company_name}`);
      logInfo(`SIREN: ${client.siren}`);

      // V√©rifier les produits √©ligibles
      const cpeResponse = await fetch(`${API_BASE_URL}/api/clients/${this.clientId}/produits-eligibles`);
      const cpeResult = await cpeResponse.json();

      if (cpeResult.success) {
        const produitsEligibles = cpeResult.data;
        logSuccess('Produits √©ligibles v√©rifi√©s');
        logInfo(`${produitsEligibles.length} produits √©ligibles trouv√©s`);

        produitsEligibles.forEach(cpe => {
          const status = cpe.statut === 'eligible' ? 'üü¢' : 'üü°';
          log(`${status} ${cpe.produit_nom}: ${cpe.statut} - ${cpe.montantFinal?.toLocaleString('fr-FR') || 0}‚Ç¨`);
        });
      }

      // V√©rifier les sessions migr√©es
      const migrationsResponse = await fetch(`${API_BASE_URL}/api/session-migration/client/${this.clientId}/migrations`);
      const migrationsResult = await migrationsResponse.json();

      if (migrationsResult.success) {
        const migrations = migrationsResult.data.migrated_sessions;
        logSuccess('Sessions migr√©es v√©rifi√©es');
        logInfo(`${migrations.length} session(s) migr√©e(s)`);
      }

      this.testResults.dataVerified = true;

    } catch (error) {
      logError(`√âchec v√©rification donn√©es: ${error.message}`);
      throw error;
    }
  }

  displayFinalReport() {
    logStep(8, 'Rapport final');

    const totalSteps = Object.keys(this.testResults).length;
    const successfulSteps = Object.values(this.testResults).filter(Boolean).length;
    const successRate = (successfulSteps / totalSteps) * 100;

    log(`${colors.bright}${colors.magenta}üìä R√âSULTATS DES TESTS${colors.reset}`, 'magenta');
    log(`üéØ Taux de r√©ussite: ${successRate.toFixed(1)}% (${successfulSteps}/${totalSteps})`, successRate === 100 ? 'green' : 'yellow');

    log('\nüìã D√©tail des √©tapes:');
    Object.entries(this.testResults).forEach(([step, success]) => {
      const status = success ? '‚úÖ' : '‚ùå';
      const color = success ? 'green' : 'red';
      log(`   ${status} ${step}: ${success ? 'Succ√®s' : '√âchec'}`, color);
    });

    if (successRate === 100) {
      log('\nüéâ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS !', 'green');
      log('‚úÖ Le process de migration session ‚Üí client fonctionne parfaitement', 'green');
    } else {
      log('\n‚ö†Ô∏è CERTAINS TESTS ONT √âCHOU√â', 'yellow');
      log('üîß V√©rifiez les erreurs ci-dessus et corrigez les probl√®mes', 'yellow');
    }

    log('\nüìà Statistiques:');
    log(`   - Session cr√©√©e: ${this.sessionToken ? 'Oui' : 'Non'}`);
    log(`   - Client cr√©√©: ${this.clientId ? 'Oui' : 'Non'}`);
    log(`   - Email de test: ${TEST_EMAIL}`);
    log(`   - Client ID: ${this.clientId || 'N/A'}`);

    log('\nüßπ Nettoyage:');
    log('   Pour nettoyer les donn√©es de test, supprimez le client cr√©√© dans l\'interface admin');
  }
}

// Fonction principale
async function main() {
  try {
    const tester = new MigrationTester();
    await tester.runTests();
  } catch (error) {
    logError(`Erreur fatale: ${error.message}`);
    process.exit(1);
  }
}

// Ex√©cution si le script est appel√© directement
if (require.main === module) {
  main();
}

module.exports = MigrationTester; 