# ğŸ“Š MODÃˆLE DE COMMISSION PROFITUM (Waterfall)

## ğŸ”„ FLUX COMPLET

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REMBOURSEMENT CLIENT                      â”‚
â”‚                        10,000 â‚¬                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Paie 30% (client_fee_percentage)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXPERT REÃ‡OIT                              â”‚
â”‚                        3,000 â‚¬                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Paie 30% (profitum_fee_percentage)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PROFITUM REÃ‡OIT                             â”‚
â”‚                         900 â‚¬                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ Reverse 10% (apporteur_share_percentage)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  APPORTEUR REÃ‡OIT                             â”‚
â”‚                         90 â‚¬                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  RÃ‰SULTAT NET POUR CHACUN                                  â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•‘
â•‘  â€¢ Expert garde:     2,100 â‚¬ (70% de 3,000â‚¬)              â•‘
â•‘  â€¢ Profitum garde:     810 â‚¬ (90% de 900â‚¬)                â•‘
â•‘  â€¢ Apporteur reÃ§oit:    90 â‚¬ (10% de 900â‚¬)                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ—„ï¸ STRUCTURE BDD

### Table `Expert`
```sql
-- Colonnes renommÃ©es pour clartÃ©
client_fee_percentage      NUMERIC(5,4) DEFAULT 0.30
  â†’ % que le CLIENT paie Ã  l'EXPERT

profitum_fee_percentage    NUMERIC(5,4) DEFAULT 0.30
  â†’ % que l'EXPERT paie Ã  PROFITUM
```

### Table `ApporteurAffaires`
```sql
-- Colonne renommÃ©e
profitum_share_percentage  NUMERIC(5,4) DEFAULT 0.10
  â†’ % que PROFITUM reverse Ã  l'APPORTEUR
```

### Table `invoice`
```sql
montant_remboursement       NUMERIC(10,2)  -- Base de calcul
client_fee_percentage       NUMERIC(5,4)   -- Taux clientâ†’expert
expert_total_fee            NUMERIC(10,2)   -- Montant clientâ†’expert
profitum_fee_percentage     NUMERIC(5,4)   -- Taux expertâ†’profitum
profitum_total_fee          NUMERIC(10,2)   -- Montant expertâ†’profitum
apporteur_share_percentage  NUMERIC(5,4)   -- Taux profitumâ†’apporteur
apporteur_commission        NUMERIC(10,2)   -- Montant profitumâ†’apporteur
amount                      NUMERIC(10,2)   -- = profitum_total_fee (HT)
```

---

## ğŸ’» CALCUL DANS LE CODE

```typescript
// Service FactureService.generate()

// 1. Client â†’ Expert
const expertTotalFee = montantRemboursement * client_fee_percentage;

// 2. Expert â†’ Profitum
const profitumTotalFee = expertTotalFee * profitum_fee_percentage;

// 3. Profitum â†’ Apporteur
const apporteurCommission = profitumTotalFee * apporteur_share_percentage;

// 4. TVA et TTC (sur ce que Profitum facture)
const tva = profitumTotalFee * 0.20;
const profitumTotalTTC = profitumTotalFee + tva;

// 5. Ce que garde chacun
const expertKeeps = expertTotalFee - profitumTotalFee;
const profitumKeeps = profitumTotalFee - apporteurCommission;
```

---

## ğŸ“‹ EXEMPLE CONCRET

### Remboursement: 15,000 â‚¬

| Ã‰tape | Calcul | Montant |
|-------|--------|---------|
| 1ï¸âƒ£ Client paie expert (30%) | 15,000 Ã— 0.30 | **4,500 â‚¬** |
| 2ï¸âƒ£ Expert paie Profitum (30%) | 4,500 Ã— 0.30 | **1,350 â‚¬** |
| 3ï¸âƒ£ Profitum reverse apporteur (10%) | 1,350 Ã— 0.10 | **135 â‚¬** |
| TVA Profitum (20%) | 1,350 Ã— 0.20 | **270 â‚¬** |
| **Facture Profitum TTC** | 1,350 + 270 | **1,620 â‚¬** |

### RÃ©partition finale:
- **Expert garde:** 3,150 â‚¬ (4,500 - 1,350)
- **Profitum garde:** 1,215 â‚¬ (1,350 - 135)
- **Apporteur reÃ§oit:** 135 â‚¬

---

## ğŸ¯ AFFICHAGE MODAL CLIENT

Le client voit:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¼ Conditions de rÃ©munÃ©ration Profitum       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ Montant remboursement: 15,000 â‚¬             â”‚
â”‚                                              â”‚
â”‚ 1ï¸âƒ£ Vous payez 30% Ã  l'expert: 4,500 â‚¬       â”‚
â”‚ 2ï¸âƒ£ L'expert paie 30% Ã  Profitum: 1,350 â‚¬    â”‚
â”‚ 3ï¸âƒ£ Profitum reverse 10% Ã  l'apporteur: 135 â‚¬â”‚
â”‚                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ Facture Profitum HT: 1,350 â‚¬                â”‚
â”‚ TVA (20%): 270 â‚¬                             â”‚
â”‚ Total TTC: 1,620 â‚¬                           â”‚
â”‚                                              â”‚
â”‚ â„¹ï¸ BasÃ©e sur le montant RÃ‰EL reÃ§u           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… MIGRATIONS Ã€ EXÃ‰CUTER

```bash
# 1. Renommer colonnes + defaults
psql -f server/migrations/20250110_fix_commissions_v2.sql

# 2. Ajouter statuts workflow
psql -f server/migrations/20250110_add_workflow_statuses.sql
```

---

## ğŸ”„ TIMELINE DES Ã‰VÃ‰NEMENTS

1. **Client valide audit** â†’ Enregistre conditions waterfall dans `metadata`
2. **Expert soumet dossier** â†’ Timeline + notifs
3. **Expert saisit rÃ©sultat final** â†’ ğŸ§¾ **FACTURE AUTO GÃ‰NÃ‰RÃ‰E** avec waterfall
4. **Client confirme paiement** â†’ Dossier `completed`

---

## ğŸ“Š FICHIERS MODIFIÃ‰S

### Backend:
- âœ… `server/src/services/facture-service.ts` - Calcul waterfall
- âœ… `server/src/routes/expert-dossier-actions.ts` - Routes + API responses
- âœ… `server/migrations/20250110_fix_commissions_v2.sql` - BDD

### Frontend:
- â³ `client/src/components/client/AuditValidationModal.tsx` - Affichage waterfall
- â³ `client/src/components/client/InvoiceDisplay.tsx` - Affichage facture
- â³ `client/src/components/expert/FinalResultModal.tsx` - Info gÃ©nÃ©ration

---

**Date crÃ©ation:** 2025-11-05  
**Version:** 2.0 (Waterfall correct)

